#!/usr/bin/env bash
#
# This is a wrapper script for starting mkdocs and the users web-browser
#

##############################################################################
# Shell Behaviour
##############################################################################

# Check for unbound variables being used
# set -o nounset

# Exit is a bad command is attempted. If you're going to handle errors then
# leave this disabled
# set -o errexit

# Exit if any of the commands in a pipeline exit with a non-zero exit code
# set -o pipefail

##############################################################################
# Variables
##############################################################################

CONST_COMMAND_LINE="$@"
CONST_OS_VERSION=$(uname -r)
CONST_SYSTEM_TYPE=$(uname -m)
CONST_SCRIPT_NAME=${0##*/}

# The PROJECT_ROOT is TWO level up from where the scripts run in the
# 'bin/subcommands' directory
PROJECT_ROOT=$( cd "$( dirname "${BASH_SOURCE[0]}" )/../../" && pwd )

# Load the Frameverk
. ${PROJECT_ROOT}/etc/axerc

# Current logging config
TTY_OUTPUT_ENABLED=$TRUE
LOG_OUTPUT_ENABLED=$TRUE
SYSLOG_OUTPUT_ENABLED=$FALSE
EVENT_OUTPUT_ENABLED=$TRUE
export TTY_OUTPUT_ENABLED LOG_OUTPUT_ENABLED SYSLOG_OUTPUT_ENABLED EVENT_OUTPUT_ENABLED

# Default log file
DEFAULT_OUT="${PROJECT_ROOT}/log/${CONST_SCRIPT_NAME}.log"
# Define somewhere for specific log messages to go
EVENT_LOG="${PROJECT_ROOT}/log/${CONST_SCRIPT_NAME}_events.log"
export DEFAULT_OUT EVENT_LOG

# Trap normal and abnormal termination
trap cleanup 0 1 2 3 15


##############################################################################
# Main Script
##############################################################################

BROWSER=$(which x-www-browser)

[ -z $BROWSER ] && echo "No default browser found (using x-www-browser). Maybe its time to use a real OS" && exit 1

cleanup() {
    _log "$LINENO" "Shutdown of local DOCS service"
    kill -9 $pid_mkdocs
}


# Unset any proxies as it's only localhost we're connecting to
unset http_proxy
unset https_proxy

# Start MkDocs
_log "$LINENO" "Starting the DOCs service"
cd $PROJECT_ROOT/docs
CMD_MKDOCS=$(which mkdocs)
$CMD_MKDOCS serve &
pid_mkdocs=$!

# Start the Browser after a short wait
_log "$LINENO" "Starting your default Web Browser"
sleep 2
$BROWSER "http://localhost:8000"
